# 基本構文

## Excelファイル操作

```
Sub Sample()

    ' === 変数宣言 ===
    Dim wb As Workbook          ' 処理対象のブック
    Dim filePath As String      ' フルパス（フォルダ + ファイル名）
    Dim fileName As String      ' Dir関数で取得するファイル名
    Dim sheetName As String     ' 対象シート名
    Dim needSave As Boolean     ' 保存が必要かどうかのフラグ
    
    ' 対象シート名を定義
    sheetName = "Sheet1"
    
    ' カレントブックと同じフォルダ内の「Book」を含むxlsxファイルを取得
    fileName = Dir(ThisWorkbook.Path & "\*Book*.xlsx")
    
    ' ファイルが存在する間、繰り返し処理
    Do While fileName <> ""
    
        ' === 1ファイル分の初期化 ===
        needSave = False        ' デフォルトでは保存しない
        Set wb = Nothing        ' 前回の参照をクリア
        
        ' フルパスを組み立て
        filePath = ThisWorkbook.Path & "\" & fileName

        ' 以降の処理でエラーが起きたら ErrHandler にジャンプ
        On Error GoTo ErrHandler

        ' ブックを開く
        Set wb = Workbooks.Open(filePath)

        ' 対象シートが存在しない場合
        If Not SheetExists(wb, sheetName) Then
            MsgBox sheetName & "が存在しません"
            GoTo Finally        ' 後処理（Close）へ
        End If
        
        ' Sheet1 の A1 セルに「あ」を書き込む
        wb.Worksheets(sheetName).Range("A1").Value = "あ"
        
        ' データを書き換えたので保存が必要
        needSave = True
    
Finally:
        ' === Finally相当の後処理 ===
        ' エラーの有無に関わらず、ブックを必ず閉じる
        If Not wb Is Nothing Then
            wb.Close SaveChanges:=needSave
        End If
        
        ' オブジェクト参照を解放
        Set wb = Nothing
        
        ' エラーハンドリングを解除
        On Error GoTo 0
        
        ' 次のファイルを取得
        fileName = Dir()
    Loop
    
    Exit Sub   ' 正常終了

ErrHandler:
    ' === エラー発生時の処理 ===
    MsgBox "エラーが発生しました。：" & vbCrLf & _
           "ファイル：" & fileName & vbCrLf & _
           Err.Description
    
    ' 後処理（Finally）を実行してからループ継続
    Resume Finally

End Sub

' 指定したシートが存在するかを判定する関数
Function SheetExists(wb As Workbook, sheetName As String) As Boolean
    Dim ws As Worksheet

    ' シート取得時のエラーを一時的に無視
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0

    ' 取得できていれば True、できなければ False
    SheetExists = Not ws Is Nothing
End Function
```

---
